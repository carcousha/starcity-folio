// @ts-nocheck
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import { ConnectionManager, ConnectionStatus } from '../../services/connectionManager';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  throw new Error('Missing Supabase environment variables');
}

// Get singleton instance of ConnectionManager
const connectionManager = ConnectionManager.getInstance();

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  },
  global: {
    fetch: async (url, options = {}) => {
      // Check connection status before making request
      if (connectionManager.getStatus() === ConnectionStatus.OFFLINE) {
        // If we're offline, don't even try to make the request
        throw new Error('You are currently offline. Please check your internet connection and try again.');
      }
      
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), 60000); // 60 second timeout
      
      try {
        const response = await fetch(url, {
          ...options,
          signal: controller.signal,
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            ...options.headers,
            'Cache-Control': 'no-cache',
            'apikey': SUPABASE_PUBLISHABLE_KEY,
            'Authorization': `Bearer ${SUPABASE_PUBLISHABLE_KEY}`,
          },
        });
        
        return response;
      } catch (error) {
        console.log('Supabase fetch error:', error?.message || error);
        // Add more detailed error logging
        if (error instanceof TypeError && error.message === 'Failed to fetch') {
          console.log('Network connection issue detected.');
          // Update connection status to offline
          connectionManager.setStatus(ConnectionStatus.OFFLINE);
        } else if (error.name === 'AbortError') {
          console.log('Request timed out after 60 seconds');
        }
        throw error;
      } finally {
        clearTimeout(id);
      }
    },
  },
  db: {
    schema: 'public',
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
  // Add retry logic for failed connections
  shouldRetry: (error) => {
    return error.statusCode === 429 || error.statusCode >= 500;
  },
  retryCount: 3,
  retryInterval: 2000,
});