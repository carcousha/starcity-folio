# 🔧 دليل تشخيص مشكلة إرسال رسائل الواتساب الجماعية

## 🎯 المشكلة
عند محاولة إرسال رسائل جماعية من صفحة الوسطاء، تظهر رسالة "تم الإرسال" ولكن لا تصل الرسائل فعلياً.

## 🔍 خطوات التشخيص

### 1. **فحص إعدادات الواتساب**
اذهب إلى: `http://localhost:5173/debug_whatsapp_settings.html`

اضغط على زر "فحص إعدادات الواتساب" وتأكد من:
- ✅ وجود API Key
- ✅ وجود Sender Number  
- ✅ أن الإعدادات نشطة (is_active = true)

### 2. **اختبار API الواتساب**
في نفس الصفحة، اضغط على زر "اختبار API الواتساب" وتأكد من:
- ✅ أن API يستجيب بنجاح
- ✅ عدم وجود أخطاء في الاتصال

### 3. **فحص بيانات الوسطاء**
اضغط على زر "فحص الوسطاء" وتأكد من:
- ✅ أن الوسطاء لديهم أرقام واتساب
- ✅ أن الأرقام بتنسيق صحيح (971xxxxxxxxx)

## 🛠️ أدوات التشخيص المتاحة

### صفحة فحص الإعدادات
```
http://localhost:5173/debug_whatsapp_settings.html
```
- فحص إعدادات الواتساب في قاعدة البيانات
- اختبار API الواتساب مباشرة
- فحص بيانات الوسطاء

### صفحة اختبار الإرسال
```
http://localhost:5173/test_whatsapp_send.html
```
- اختبار إرسال رسائل فردية
- مقارنة بين wa.me و API
- تشخيص مشاكل الاتصال

## 🔍 فحص Console

افتح Developer Tools (F12) واذهب إلى Console، ثم حاول إرسال رسالة جماعية. ابحث عن الرسائل التالية:

### رسائل النجاح:
```
handleBulkWhatsApp called
selectedBrokers size: X
إرسال الرسائل لـ: X وسيط
إرسال رسالة لـ: [اسم الوسيط] - [رقم الهاتف]
تم إرسال الرسالة بنجاح لـ: [اسم الوسيط]
نتائج الإرسال: { total: X, successful: X, failed: X }
```

### رسائل الخطأ:
```
❌ لا توجد إعدادات واتساب نشطة
❌ خطأ في الاتصال بقاعدة البيانات
❌ فشل في اختبار API
❌ لا يوجد رقم واتساب لـ: [اسم الوسيط]
```

## 🚨 الأخطاء الشائعة وحلولها

### خطأ: "لا توجد إعدادات واتساب نشطة"
**الحل:**
1. اذهب إلى `/whatsapp/settings`
2. أضف API Key و Sender Number
3. تأكد من تفعيل الإعدادات

### خطأ: "فشل في اختبار API"
**الحل:**
1. تحقق من صحة API Key
2. تأكد من أن Sender Number مسجل في WhatsApp Business
3. تحقق من اتصال الإنترنت

### خطأ: "لا يوجد رقم واتساب"
**الحل:**
1. تأكد من أن الوسطاء لديهم أرقام واتساب
2. تحقق من تنسيق الأرقام (يجب أن تبدأ بـ 971)

## 📋 قائمة التحقق

### قبل الإرسال:
- [ ] الخادم يعمل على `http://localhost:5173`
- [ ] تم تسجيل الدخول بحس له صلاحيات
- [ ] تم اختيار وسطاء للإرسال
- [ ] تم كتابة رسالة
- [ ] إعدادات الواتساب موجودة ونشطة

### بعد الإرسال:
- [ ] تحقق من Console للأخطاء
- [ ] تحقق من رسائل النجاح/الفشل
- [ ] اختبر wa.me إذا فشل API
- [ ] تحقق من إعدادات الواتساب

## 🔄 إعادة تشغيل الخادم

إذا واجهت مشاكل:
```bash
# أوقف الخادم
Ctrl + C

# أعد تشغيل الخادم
npm run dev

# تحقق من المنفذ
netstat -ano | findstr :5173
```

## 📞 الدعم

إذا استمرت المشكلة:
1. التقط screenshot من Console
2. سجل رسائل الخطأ
3. تأكد من إعدادات الواتساب
4. اختبر صفحة التشخيص أولاً

---

**ملاحظة:** هذا الدليل محدث بتاريخ: `2024-12-19`
